<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/jquery.dataTables.css">
    <script src="/js/jquery-3.2.1.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/jquery.dataTables.min.js"></script>
</head>
<body>

<div class="container" style="margin-top: 50pt">

    <div class="row">
        <form class="needs-validation"  action="/task/add" method="post" novalidate>
            <div class="form-group row">
                <div class="col-md-4 mb-3">
                    <label class="control-label col-md-4">id</label>
                    <input class="form-control" type="text" name="id" required>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="control-label col-md-4">func</label>
                    <input class="form-control" type="text" name="func">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="control-label col-md-4">script</label>
                    <input class="form-control" type="file" name="script">
                </div>
            </div>
            <div class="form-group row">
                <div class="col-md-4 mb-3">
                    <label class="control-label col-md-4">trigger</label>
                    <select class="form-control" name="trigger">
                        <option value="interval">interval</option>
                        <option value="cron">cron</option>
                    </select>
                </div>
                <div class="col-md-6 mb-6">
                    <label class="control-label col-md-4">trigger value</label>
                    <input class="form-control" type="text" name="trigger_value" placeholder="eg: seconds=80">
                </div>
            </div>
            <button class="btn btn-primary pull-right" type="submit">添加</button>
        </form>
    </div>
    <br/>
    <div class="row">
        <table id="tasks" class="table table-striped table-bordered table-hover" width="100%">
            <thead>
                <tr>
                    <th>name</th>
                    <th>func</th>
                    <th>trigger</th>
                    <th>trigger value</th>
                    <th>start date</th>
                    <th>next run time</th>
                    <th>操作</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

<script type="text/javascript">
// Example starter JavaScript for disabling form submissions if there are invalid fields
(function() {
  'use strict';
  window.addEventListener('load', function() {
    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.getElementsByClassName('needs-validation');
    // Loop over them and prevent submission
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);

})();

var table = null;
$(function () {
   // init table
   load_table();

});

function load_table() {
    // init table
   $.get('/scheduler/jobs', function (data, status) {
       if (status === 'success'){
           var res = [];
           for (var i in data){
               var task = {
                   'name': data[i]['name'],
                   'func': data[i]['func'],
                   'trigger': data[i]['trigger'],
                   'start_date': data[i]['start_date'],
                   'next_run_time': data[i]['next_run_time']
               };

               var value = '';
               if (data[i]['trigger'] === 'interval'){
                   if (typeof(data[i]['days']) !== 'undefined'){
                       value += 'days:' + data[i]['days'] + ' ';
                   }
                   if (typeof(data[i]['hours']) !== 'undefined'){
                       value += 'hours:' + data[i]['hours'] + ' ';
                   }
                   if (typeof(data[i]['minutes']) !== 'undefined'){
                       value += 'minutes:' + data[i]['minutes'] + ' ';
                   }
                   if (typeof(data[i]['seconds']) !== 'undefined'){
                       value += 'seconds:' + data[i]['seconds']
                   }
               }else if (data[i]['trigger'] === 'cron'){
                   if (typeof(data[i]['day']) !== 'undefined'){
                       value += 'day:' + data[i]['day'] + ' ';
                   }
                   if (typeof(data[i]['hour']) !== 'undefined'){
                       value += 'hour:' + data[i]['hour'] + ' ';
                   }
                   if (typeof(data[i]['minute']) !== 'undefined'){
                       value += 'minute:' + data[i]['minute'] + ' ';
                   }
                   if (typeof(data[i]['second']) !== 'undefined'){
                       value += 'second:' + data[i]['second']
                   }
               }
               task['trigger_value'] = value;

               var oper = '<a href="#" onclick="start_task(\'' + data[i]['name'] + '\')">执行&nbsp&nbsp</a>' +
                          '<a href="#" onclick="pause_task(\'' + data[i]['name'] + '\')">暂停&nbsp&nbsp</a> ' +
                          '<a href="#" onclick="resume_task(\'' + data[i]['name'] + '\')">恢复&nbsp&nbsp</a> ' +
//                          '<a href="#" onclick="update_task('' + data[i]['name'] + '')">更新&nbsp&nbsp</a> ' +
                          '<a href="#" onclick="delete_task(\'' + data[i]['name'] + '\')">删除&nbsp&nbsp</a> ';
               task['oper'] = oper;
               res.push(task);
           }
           table = $('#tasks').DataTable({
                "data": res,
                "columns": [
                    {"data": "name"},
                    {"data": "func"},
                    {"data": "trigger"},
                    {"data": "trigger_value"},
                    {"data": "start_date"},
                    {"data": "next_run_time"},
                    {"data": "oper"}
                ]
           });
       }
   })
}

//it will add some api for scheduler prefix is /scheduler
//get_scheduler_info', '', api.get_scheduler_info, 'GET'
//add_job', '/jobs', api.add_job, 'POST'
//get_job', '/jobs/<job_id>', api.get_job, 'GET'
//get_jobs', '/jobs', api.get_jobs, 'GET'
//delete_job', '/jobs/<job_id>', api.delete_job, 'DELETE'
//update_job', '/jobs/<job_id>', api.update_job, 'PATCH'
//pause_job', '/jobs/<job_id>/pause', api.pause_job, 'POST'
//resume_job', '/jobs/<job_id>/resume', api.resume_job, 'POST'
//run_job', '/jobs/<job_id>/run', api.run_job, 'POST'

function pause_task(name) {
    $.post('/scheduler/jobs/' + name + '/pause', function (data, status) {
        console.log(data);
        if (status === 'success'){
            alert('暂停成功');
        }else{
            alert('暂停失败');
        }
    }).fail(function (error) {
        alert('暂停失败' + error.errorMessage());
    })
}

function resume_task(name) {
    $.post('/scheduler/jobs/' + name + '/resume', function (data, status) {
        console.log(data);
        if (status === 'success'){
            alert('恢复成功');
        }else{
            alert('恢复失败')
        }
    }).fail(function (error) {
        alert('恢复失败' + error.errorMessage());
    })
}

function start_task(name) {
    $.post('/scheduler/jobs/' + name + '/run', function (data, status) {
        console.log(data);
        if (status === 'success'){
            alert('启动成功');
        }else{
            alert('启动失败');
        }
    }).fail(function (error) {
        alert('启动失败' + error.errorMessage());
    })
}

function delete_task(name) {
    $.ajax({
       type: "DELETE",
       url: "/scheduler/jobs/" + name,
       contentType: "application/json",
       dataType: "json",
       success:function(data){
           alert('删除成功');
           load_table();
       },
       error:function(){
           alert('删除失败');
       }
    });
}
</script>
</body>
</html>